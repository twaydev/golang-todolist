name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

jobs:
  # ===========================================================================
  # Deploy to Railway
  # ===========================================================================
  deploy:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: curl -fsSL https://railway.app/install.sh | sh

      - name: Deploy to Railway
        run: |
          echo "Deploying to Railway..."
          railway up --detach

          echo "## Deployment Initiated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Railway will automatically:" >> $GITHUB_STEP_SUMMARY
          echo "- Build the Docker image" >> $GITHUB_STEP_SUMMARY
          echo "- Run database migrations on startup" >> $GITHUB_STEP_SUMMARY
          echo "- Start the application" >> $GITHUB_STEP_SUMMARY
          echo "- Verify health check" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Verify Deployment
  # ===========================================================================
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [deploy]
    if: success()

    steps:
      - name: Wait for deployment
        run: |
          echo "Waiting 90 seconds for Railway to build and deploy..."
          sleep 90

      - name: Health check
        env:
          DEPLOY_URL: ${{ secrets.RAILWAY_PUBLIC_URL }}
        run: |
          if [ -z "$DEPLOY_URL" ]; then
            echo "::warning::RAILWAY_PUBLIC_URL not set - skipping health check"
            exit 0
          fi

          echo "Checking health at $DEPLOY_URL/health"
          for i in 1 2 3 4 5; do
            RESPONSE=$(curl -sf "$DEPLOY_URL/health" 2>/dev/null) && {
              echo "âœ… Health check passed!"
              echo "$RESPONSE"
              exit 0
            }
            echo "Attempt $i/5 failed, retrying in 30s..."
            sleep 30
          done

          echo "::error::Health check failed after 5 attempts"
          exit 1

      - name: API smoke test
        env:
          DEPLOY_URL: ${{ secrets.RAILWAY_PUBLIC_URL }}
        run: |
          if [ -z "$DEPLOY_URL" ]; then
            echo "Skipping smoke test - RAILWAY_PUBLIC_URL not set"
            exit 0
          fi

          echo "Testing registration endpoint..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST "$DEPLOY_URL/auth/register" \
            -H "Content-Type: application/json" \
            -d '{"email":"smoke-test-'$GITHUB_RUN_ID'@example.com","password":"password123"}')

          if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "409" ]; then
            echo "âœ… Registration endpoint working (HTTP $HTTP_CODE)"
          else
            echo "::warning::Unexpected response: HTTP $HTTP_CODE"
          fi

  # ===========================================================================
  # Summary
  # ===========================================================================
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy, verify]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${GITHUB_SHA::7}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ github.event.inputs.environment || 'production' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Verify | ${{ needs.verify.result == 'success' && 'âœ…' || needs.verify.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
