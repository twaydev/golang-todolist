name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

jobs:
  # ===========================================================================
  # Deploy to Railway
  # ===========================================================================
  deploy:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ steps.deploy.outputs.url }}

    # Only deploy if CI passes (when triggered by push)
    needs: []

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: |
          curl -fsSL https://railway.app/install.sh | sh

      - name: Deploy to Railway
        id: deploy
        run: |
          railway up --detach
          echo "Deployment initiated"

      - name: Get deployment URL
        run: |
          echo "Deployed to Railway"
          echo "Check Railway dashboard for deployment status"

  # ===========================================================================
  # Post-deployment verification
  # ===========================================================================
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [deploy]
    if: success()

    steps:
      - name: Wait for deployment
        run: sleep 60

      - name: Health check
        run: |
          # Get the Railway public URL from secrets or use a known URL
          DEPLOY_URL="${{ secrets.RAILWAY_PUBLIC_URL }}"
          if [ -n "$DEPLOY_URL" ]; then
            echo "Checking health at $DEPLOY_URL/health"
            curl -f "$DEPLOY_URL/health" || echo "Health check pending - deployment may still be in progress"
          else
            echo "RAILWAY_PUBLIC_URL not set - skipping health check"
          fi

  # ===========================================================================
  # Notify on deployment
  # ===========================================================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [deploy, verify]
    if: always()

    steps:
      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "**Status:** Deployment successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** Deployment failed" >> $GITHUB_STEP_SUMMARY
          fi
