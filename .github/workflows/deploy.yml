name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  # Use Project Token from Railway (Project Settings > Tokens > Create Token)
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

jobs:
  # ===========================================================================
  # Deploy to Railway
  # ===========================================================================
  deploy:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: |
          curl -fsSL https://railway.app/install.sh | sh

      - name: Check Railway Token
        run: |
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "::error::RAILWAY_TOKEN secret is not set"
            echo ""
            echo "To fix this:"
            echo "1. Go to Railway dashboard > Your Project > Settings > Tokens"
            echo "2. Create a new Project Token"
            echo "3. Add it as RAILWAY_TOKEN in GitHub Secrets"
            exit 1
          fi
          echo "Railway token is configured"

      - name: Deploy to Railway
        id: deploy
        run: |
          # Deploy using Railway CLI
          railway up --detach 2>&1 | tee deploy.log

          # Check if deployment was successful
          if grep -q "Deployment initiated" deploy.log || grep -q "Deploy" deploy.log; then
            echo "Deployment initiated successfully"
          else
            echo "::warning::Deployment may have issues, check Railway dashboard"
          fi

      - name: Get deployment URL
        run: |
          echo "## Deployment Initiated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check [Railway Dashboard](https://railway.app/dashboard) for deployment status" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Post-deployment verification
  # ===========================================================================
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [deploy]
    if: success()

    steps:
      - name: Wait for deployment
        run: |
          echo "Waiting 90 seconds for deployment to complete..."
          sleep 90

      - name: Health check
        run: |
          DEPLOY_URL="${{ secrets.RAILWAY_PUBLIC_URL }}"
          if [ -n "$DEPLOY_URL" ]; then
            echo "Checking health at $DEPLOY_URL/health"
            for i in 1 2 3; do
              if curl -sf "$DEPLOY_URL/health"; then
                echo ""
                echo "Health check passed!"
                exit 0
              fi
              echo "Attempt $i failed, retrying in 30s..."
              sleep 30
            done
            echo "::warning::Health check failed after 3 attempts"
          else
            echo "RAILWAY_PUBLIC_URL not set - skipping health check"
            echo "Add RAILWAY_PUBLIC_URL secret to enable health checks"
          fi

  # ===========================================================================
  # Notify on deployment
  # ===========================================================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [deploy, verify]
    if: always()

    steps:
      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ github.event.inputs.environment || 'production' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "### Status: ✅ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Status: ❌ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          fi
