# Feature Decomposition Rules for Orchestrator

# This file defines how the orchestrator should decompose different types
# of features into agent-specific tasks.

decomposition_patterns:
  
  # Full feature with all layers
  full_feature:
    description: Complete feature affecting all layers
    example: "Create Todo with Priority"
    phases:
      - phase: 1
        name: Test-First
        agent: test-first-agent
        sequential: true
        tasks:
          - Write BDD scenarios (features/*.feature)
          - Create step definitions (test/bdd/*_steps_test.go)
          - Write unit test stubs (test/unit/domain/*_test.go)
          - Verify RED state
        output: All tests FAIL (RED)
        
      - phase: 2
        name: Implementation
        parallel: true
        agents:
          - domain-logic-agent
          - database-agent
        tasks:
          domain-logic-agent:
            - Define entities (internal/domain/entity/*.go)
            - Define port interfaces (internal/domain/port/output/*.go)
            - Implement services (internal/domain/service/*.go)
          database-agent:
            - Create migrations (migrations/*.sql)
            - Add indexes and constraints
            - Enable RLS policies
            - Implement repositories (internal/adapter/driven/postgres/*_repo.go)
        output: All tests PASS (GREEN)
        
      - phase: 3
        name: Adapters
        parallel: true
        agents:
          - api-adapter-agent
          - ai-nlp-agent
        tasks:
          api-adapter-agent:
            - Implement REST API (internal/adapter/driving/http/*.go)
            - Implement Telegram bot (internal/adapter/driving/telegram/*.go)
            - Create DTOs and validation
          ai-nlp-agent:
            - Update Perplexity client (internal/adapter/driven/perplexity/*.go)
            - Update intent service (internal/domain/service/intent_service.go)
            - Update prompts (prompts/*.txt)
        output: Integration tests PASS
        
      - phase: 4
        name: Infrastructure
        sequential: true
        agent: infrastructure-agent
        tasks:
          - Review CI/CD (.github/workflows/*.yml)
          - Review Docker (Dockerfile)
          - Deploy to Railway
          - Verify health checks
        output: Deployment SUCCESS, health check PASS

  # API-only feature (no NLP)
  api_feature:
    description: REST API feature without natural language support
    example: "Export Todos to CSV"
    skip_agents:
      - ai-nlp-agent
    phases:
      - phase: 1
        agent: test-first-agent
      - phase: 2
        agents: [domain-logic-agent, database-agent]
      - phase: 3
        agents: [api-adapter-agent]
      - phase: 4
        agent: infrastructure-agent

  # Schema change only
  schema_change:
    description: Database schema modification
    example: "Add index to todos table"
    skip_agents:
      - test-first-agent  # May not need new tests
      - api-adapter-agent
      - ai-nlp-agent
    phases:
      - phase: 2
        agents: [database-agent]
      - phase: 4
        agent: infrastructure-agent

  # NLP enhancement
  nlp_feature:
    description: Natural language processing improvement
    example: "Parse relative dates in Vietnamese"
    skip_agents:
      - database-agent
      - api-adapter-agent
    phases:
      - phase: 1
        agent: test-first-agent
      - phase: 2
        agents: [domain-logic-agent]  # May need intent schema updates
      - phase: 3
        agents: [ai-nlp-agent]
      - phase: 4
        agent: infrastructure-agent

  # Infrastructure only
  infrastructure_change:
    description: CI/CD or deployment configuration
    example: "Add code coverage reporting"
    skip_agents:
      - test-first-agent
      - domain-logic-agent
      - database-agent
      - api-adapter-agent
      - ai-nlp-agent
    phases:
      - phase: 4
        agent: infrastructure-agent

  # Bug fix
  bug_fix:
    description: Fix existing functionality
    example: "Fix todo deletion error"
    workflow: .factory/workflows/02-bug-fix-workflow.md
    phases:
      - phase: 1
        agent: test-first-agent
        tasks:
          - Write test that reproduces bug
          - Verify test FAILS
      - phase: 2
        agent: <affected-agent>  # Determined by bug location
        tasks:
          - Fix the bug
          - Verify test PASSES
      - phase: 3
        agent: test-first-agent
        tasks:
          - Add regression tests
      - phase: 4
        agent: infrastructure-agent

  # Refactoring
  refactoring:
    description: Code improvement without behavior change
    example: "Refactor TodoService to use builder pattern"
    workflow: .factory/workflows/03-refactoring-workflow.md
    phases:
      - phase: 0
        name: Verify coverage
        agent: test-first-agent
        tasks:
          - Check test coverage
          - Add tests if needed
      - phase: 2
        agent: domain-logic-agent
        tasks:
          - Refactor code
          - Ensure tests still pass
      - phase: 4
        agent: infrastructure-agent

# Decision tree for automatic decomposition
decision_tree:
  - condition: "feature mentions 'natural language' OR 'NLP' OR 'intent'"
    pattern: full_feature
    
  - condition: "feature mentions 'REST API' OR 'endpoint' AND NOT 'bot'"
    pattern: api_feature
    
  - condition: "feature mentions 'schema' OR 'migration' OR 'index' OR 'database'"
    pattern: schema_change
    
  - condition: "feature mentions 'parse' OR 'language' OR 'Vietnamese'"
    pattern: nlp_feature
    
  - condition: "feature mentions 'CI/CD' OR 'deploy' OR 'Docker'"
    pattern: infrastructure_change
    
  - condition: "feature mentions 'bug' OR 'fix' OR 'error'"
    pattern: bug_fix
    
  - condition: "feature mentions 'refactor' OR 'improve code'"
    pattern: refactoring
    
  - condition: default
    pattern: full_feature

# Layer dependencies (which layers depend on which)
dependencies:
  domain:
    depends_on: []
    depended_by: [database, adapters, nlp]
    
  database:
    depends_on: [domain]  # Needs entity structure
    depended_by: []
    
  adapters:
    depends_on: [domain]  # Needs service interfaces
    depended_by: []
    
  nlp:
    depends_on: [domain]  # Needs intent schema
    depended_by: []
    
  infrastructure:
    depends_on: [domain, database, adapters, nlp]  # Needs everything
    depended_by: []

# Estimated durations (in minutes)
time_estimates:
  test-first-agent: 30
  domain-logic-agent: 45
  database-agent: 45
  api-adapter-agent: 45
  ai-nlp-agent: 45
  infrastructure-agent: 30
  
  # Parallel phases take max(agent times)
  phase_1: 30  # Sequential
  phase_2: 45  # max(domain:45, database:45)
  phase_3: 45  # max(adapter:45, nlp:45)
  phase_4: 30  # Sequential
  
  total_full_feature: 150  # 2.5 hours

# Validation checkpoints
checkpoints:
  phase_1:
    script: orchestrator/scripts/validate-phase.sh 1
    expect: Tests FAIL (RED state)
    
  phase_2:
    script: orchestrator/scripts/validate-phase.sh 2
    expect: Tests PASS (GREEN state)
    
  phase_3:
    script: orchestrator/scripts/validate-phase.sh 3
    expect: Integration tests PASS
    
  phase_4:
    script: orchestrator/scripts/validate-phase.sh 4
    expect: Health check returns 200 OK

# Communication signals
signals:
  completion: "✅ {agent} complete"
  blocker: "⚠️ BLOCKED"
  question: "❓ Question for @orchestrator"
  ready_for_next: "Ready for {next_phase}"
